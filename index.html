<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>講師勤怠システム</title>

<style>
body{
  font-family: sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}
h1{
  text-align:center;
}
.box{
  background:#fff;
  padding:15px;
  margin-bottom:15px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
label{
  display:block;
  margin-top:10px;
}
input,select,button{
  width:100%;
  padding:8px;
  margin-top:5px;
  font-size:16px;
}
button{
  margin-top:15px;
  background:#2c7be5;
  color:white;
  border:none;
  border-radius:6px;
}
button:hover{
  opacity:0.9;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{
  background:#2c7be5;
  color:white;
}
</style>
</head>

<body>

<h1>講師勤怠システム</h1>

<div class="box">
<label>勤務日</label>
<input type="date" id="date">

<label>勤務地</label>
<select id="place">
<option value="寺津（水）">寺津（水）</option>
<option value="お城下">お城下</option>
<option value="碧南">碧南</option>
<option value="安城">安城</option>
<option value="吉良">吉良</option>
</select>

<label>開始時間</label>
<input type="time" id="start">

<label>終了時間</label>
<input type="time" id="end">

<label>時給</label>
<input type="number" id="wage" value="1670">

<label>交通費</label>
<input type="number" id="transport" value="0">

<button onclick="saveData()">保存</button>
<button onclick="exportPDF()">PDF出力</button>
</div>

<div class="box">
<h3>勤務履歴</h3>
<table>
<thead>
<tr>
<th>日付</th>
<th>勤務地</th>
<th>時間</th>
<th>合計</th>
</tr>
</thead>
<tbody id="history"></tbody>
</table>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCM55UMJ_7dzoNN-sWFKbjr6GPXagjZ45o",
  authDomain: "kintai-system-db3bb.firebaseapp.com",
  projectId: "kintai-system-db3bb",
  storageBucket: "kintai-system-db3bb.firebasestorage.app",
  messagingSenderId: "847896795149",
  appId: "1:847896795149:web:ff726d60d53a81511b1d44"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

window.db = db;
window.fb = { collection, addDoc, getDocs };

window.authReady = new Promise((resolve)=>{
  onAuthStateChanged(auth,(user)=>{
    if(user){
      window.currentUid = user.uid;
      resolve(user);
    }
  });
});

signInAnonymously(auth).catch(console.error);
</script>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
async function saveData(){
  await window.authReady;

  const date = document.getElementById("date").value;
  const place = document.getElementById("place").value;
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;
  const wage = Number(document.getElementById("wage").value);
  const transport = Number(document.getElementById("transport").value);

  const startTime = new Date(`1970-01-01T${start}:00`);
  const endTime = new Date(`1970-01-01T${end}:00`);
  const hours = (endTime - startTime) / 1000 / 60 / 60;
  const total = wage * hours + transport;

  await window.fb.addDoc(
    window.fb.collection(window.db,"kintai"),
    {date,place,start,end,total}
  );

  alert("保存しました");
  loadData();
}

async function loadData(){
  await window.authReady;
  const tbody = document.getElementById("history");
  tbody.innerHTML = "";

  const querySnapshot = await window.fb.getDocs(
    window.fb.collection(window.db,"kintai")
  );

  querySnapshot.forEach((doc)=>{
    const d = doc.data();
    tbody.innerHTML += `
      <tr>
        <td>${d.date}</td>
        <td>${d.place}</td>
        <td>${d.start}〜${d.end}</td>
        <td>${d.total.toLocaleString()}円</td>
      </tr>
    `;
  });
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("勤怠一覧",10,10);

  const rows = document.querySelectorAll("#history tr");
  let y = 20;
  rows.forEach(row=>{
    doc.text(row.innerText,10,y);
    y+=10;
  });

  doc.save("kintai.pdf");
}

loadData();
</script>

</body>
</html>
